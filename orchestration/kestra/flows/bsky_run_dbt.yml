id: run_dbt
namespace: digepi_zcde

variables:
  bq_private_key: "{{ secret('BIGQUERY_PRIVATE_KEY' ) }}"
  bq_client_email: "{{ secret('BIGQUERY_CLIENT_EMAIL') }}"

tasks:
  - id: run_dbt
    type: io.kestra.plugin.scripts.shell.Commands
    timeout: PT25M
    retry:
        type: constant
        maxAttempt: 3
        interval: PT10S
    taskRunner:
        type: io.kestra.plugin.scripts.runner.docker.Docker
        pullPolicy: ALWAYS
    containerImage: kantundpeterpan/digepi_bsky:latest
    env:
        DBT_PROJECT: "{{ secret('BIGQUERY_PROJECT_ID') }}"
        DBT_BIQUERY_PRIVATE_KEY: "{{ vars.bq_private_key }}"
        DBT_BIQUERY_CLIENT_EMAIL: "{{ vars.bq_client_email}}"
        
    commands:
      - cd /project/dbt/digepi_bsky && dbt build --profiles-dir ./docker_config
